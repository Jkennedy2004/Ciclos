name: DevSecOps Demo CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # --- [1] SAST (Static Analysis with SonarQube) ---
      - name: Set up Java for SonarQube
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      
      - name: Run SonarQube analysis
        uses: SonarSource/sonarcloud-github-action@v1.6
        with:
          projectBaseDir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
          SONAR_HOST_URL: "http://your-sonarqube-instance.com"
      
      # --- [2] SCA (Software Composition Analysis with Snyk) ---
      - name: Run Snyk scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=requirements.txt

      # --- [3] IaC Security (Infrastructure as Code with Checkov) ---
      - name: Run Checkov IaC scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: IaC/terraform/
          soft_fail: true

      # --- [4] Build Docker image ---
      - name: Build and tag Docker image
        run: docker build -t devsecops-demo:latest .

      # --- [5] DAST (Dynamic Analysis with OWASP ZAP) ---
      - name: Run the application
        run: docker-compose up -d
      
      - name: Wait for application to be ready
        run: sleep 20

      - name: Run OWASP ZAP scan
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          target: 'http://localhost:5000'